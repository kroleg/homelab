extends layout
include partials/icons

block content
  style.
    .container {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1.5rem 1rem 2rem;
    }
    .sections {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
      width: 100%;
      max-width: 32rem;
    }
    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.75rem;
    }
    .section-title {
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--muted);
    }
    .add-btn {
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
      border: 1px solid #e4e4e7;
      border-radius: 0.375rem;
      background: white;
      color: var(--foreground);
      cursor: pointer;
      text-decoration: none;
    }
    .add-btn:hover { background: var(--secondary); }
    .group-section {
      background: var(--secondary);
      border-radius: 0.75rem;
      overflow: hidden;
      box-shadow: var(--card-shadow);
    }
    .group-section + .group-section { margin-top: 0.75rem; }
    .group-section.dimmed { opacity: 0.7; }
    .group-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem 1rem;
      background: #e4e4e7;
      gap: 0.5rem;
      text-decoration: none;
      color: inherit;
    }
    .clickable {
      cursor: pointer;
    }
    .clickable:hover {
      background: #d4d4d8;
    }
    .group-info {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex: 1;
      min-width: 0;
    }
    .group-name {
      font-size: 0.9375rem;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .admin-badge {
      font-size: 0.5rem;
      padding: 0.125rem 0.25rem;
      border-radius: 0.25rem;
      background: var(--primary);
      color: white;
      flex-shrink: 0;
    }
    .group-stats {
      display: flex;
      align-items: center;
      gap: 0.375rem;
      font-size: 0.75rem;
      color: var(--muted);
      flex-shrink: 0;
    }
    .online-dot {
      width: 0.5rem;
      height: 0.5rem;
      border-radius: 50%;
      background: var(--success);
    }
    .online-count {
      color: var(--success);
      font-weight: 500;
    }
    .group-actions {
      display: flex;
      gap: 0.25rem;
    }
    .action-btn {
      font-size: 0.625rem;
      padding: 0.25rem 0.375rem;
      border: none;
      border-radius: 0.25rem;
      background: rgba(0,0,0,0.1);
      color: var(--foreground);
      cursor: pointer;
    }
    .action-btn:hover { background: rgba(0,0,0,0.2); }
    .action-btn.danger:hover { background: #fecaca; color: #dc2626; }
    .devices {
      display: flex;
      flex-direction: column;
    }
    .device-row {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.625rem 1rem;
      border-top: 1px solid #e4e4e7;
      text-decoration: none;
      color: inherit;
    }
    .device-row:first-child { border-top: none; }
    a.device-row:hover { background: #e4e4e7; }
    .status-dot {
      width: 0.5rem;
      height: 0.5rem;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .status-dot.online { background: var(--success); }
    .status-dot.offline { background: var(--muted); opacity: 0.4; }
    .device-icon {
      width: 1.125rem;
      height: 1.125rem;
      flex-shrink: 0;
    }
    .device-icon.online { color: var(--success); }
    .device-icon.offline { color: var(--muted); opacity: 0.4; }
    .device-info {
      flex: 1;
      min-width: 0;
    }
    .device-name {
      font-size: 0.875rem;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .device-details {
      font-size: 0.625rem;
      color: var(--muted);
      margin-top: 0.125rem;
    }
    .device-policy {
      font-size: 0.625rem;
      padding: 0.125rem 0.375rem;
      border-radius: 0.25rem;
      background: #dbeafe;
      color: #1e40af;
      flex-shrink: 0;
    }
    .device-actions {
      display: flex;
      gap: 0.25rem;
      flex-shrink: 0;
    }
    .empty-message {
      padding: 1rem;
      text-align: center;
      color: var(--muted);
      font-size: 0.875rem;
    }
    /* Forms */
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      align-items: center;
      justify-content: center;
      z-index: 100;
    }
    .modal:target { display: flex; }
    .modal-content {
      background: white;
      border-radius: 0.75rem;
      padding: 1.5rem;
      width: 90%;
      max-width: 24rem;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }
    .modal-title {
      font-size: 1.125rem;
      font-weight: 600;
      margin-bottom: 1rem;
    }
    .form-group {
      margin-bottom: 0.75rem;
    }
    .form-label {
      display: block;
      font-size: 0.75rem;
      font-weight: 500;
      margin-bottom: 0.25rem;
      color: var(--muted);
    }
    .form-input, .form-select {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid #a1a1aa;
      border-radius: 0.375rem;
      font-size: 0.875rem;
    }
    .form-input:disabled {
      border-color: #e4e4e7;
      background: #f4f4f5;
      color: var(--muted);
    }
    .form-input:focus, .form-select:focus {
      outline: none;
      border-color: var(--primary);
    }
    .form-checkbox {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .form-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
    }
    .btn {
      flex: 1;
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 0.375rem;
      font-size: 0.875rem;
      cursor: pointer;
      text-decoration: none;
      text-align: center;
      display: inline-block;
    }
    .btn-primary {
      background: var(--primary);
      color: white;
    }
    .btn-secondary {
      background: var(--secondary);
      color: var(--foreground);
    }
    .btn-danger {
      background: white;
      color: #dc2626;
      border: 1px solid #fecaca;
      width: 100%;
    }
    .btn-danger:hover {
      background: #fef2f2;
    }
    .delete-form {
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid #e4e4e7;
    }
    .inline-form {
      display: flex;
      gap: 0.25rem;
    }
    .inline-select {
      font-size: 0.625rem;
      padding: 0.125rem 0.25rem;
      border: 1px solid #e4e4e7;
      border-radius: 0.25rem;
      background: white;
    }

  mixin deviceList(devices)
    if devices.length === 0
      .empty-message Нет устройств
    else
      each device in devices
        - const dtype = device.deviceType || 'other'
        - const statusClass = device.online ? 'online' : 'offline'
        a.device-row.clickable(href=`#edit-device-${device.id}`)
          if dtype === 'other'
            span.status-dot(class=statusClass)
          +deviceIcon(dtype, statusClass)
          .device-info
            .device-name= device.customName || device.keeneticName || device.name || device.mac
            .device-details
              span= device.mac
              if device.ip
                span= ` • ${device.ip}`
          if device.policy
            span.device-policy= device.policy

  mixin unregisteredDeviceList(devices)
    if devices.length === 0
      .empty-message Все устройства зарегистрированы
    else
      each device in devices
        - const statusClass = device.online ? 'online' : 'offline'
        a.device-row.clickable(href=`#register-${device.mac.replace(/:/g, '')}`)
          span.status-dot(class=statusClass)
          .device-info
            .device-name= device.name
            .device-details
              span= device.mac
              if device.ip
                span= ` • ${device.ip}`
          if device.policy
            span.device-policy= device.policy

  mixin editDeviceModal(device)
    .modal(id=`edit-device-${device.id}`)
      .modal-content
        .modal-title Редактировать устройство
        form(action=`/devices/${device.id}` method="POST")
          .form-group
            label.form-label Название (из роутера)
            input.form-input(type="text" value=(device.keeneticName || '—') disabled)
          .form-group
            label.form-label Свое название
            input.form-input(type="text" name="customName" value=(device.customName || '') placeholder="Мой iPhone")
          .form-group
            label.form-label MAC
            input.form-input(type="text" value=device.mac disabled)
          .form-group
            label.form-label Владелец
            select.form-select(name="userId")
              option(value="" selected=(!device.userId)) Без владельца
              each user in allUsers
                option(value=user.id selected=(device.userId === user.id))= user.name
          .form-group
            label.form-label Тип устройства
            select.form-select(name="deviceType")
              each type in deviceTypes
                option(value=type selected=(device.deviceType === type))= type
          .form-actions
            a.btn.btn-secondary(href="#") Отмена
            button.btn.btn-primary(type="submit") Сохранить

  mixin editUserModal(user)
    .modal(id=`edit-user-${user.id}`)
      .modal-content
        .modal-title Редактировать пользователя
        form(action=`/users/${user.id}` method="POST")
          .form-group
            label.form-label Имя
            input.form-input(type="text" name="name" value=user.name required)
          .form-group
            label.form-label Slug (латиницей)
            input.form-input(type="text" name="slug" value=user.slug pattern="[a-z0-9-]+" required)
          .form-group
            label.form-checkbox
              input(type="checkbox" name="isAdmin" checked=user.isAdmin)
              span Администратор
          .form-actions
            a.btn.btn-secondary(href="#") Отмена
            button.btn.btn-primary(type="submit") Сохранить
        form.delete-form(action=`/users/${user.id}/delete` method="POST" onsubmit="return confirm('Удалить пользователя?')")
          button.btn.btn-danger(type="submit") Удалить пользователя

  .container
    .sections
      //- Users section
      .section
        .section-header
          span.section-title Пользователи
          a.add-btn(href="#add-user") + Добавить

        each user in users
          .group-section
            a.group-header.clickable(href=`#edit-user-${user.id}`)
              .group-info
                span.group-name= user.name
                if user.isAdmin
                  span.admin-badge ADMIN
              .group-stats
                if user.onlineCount > 0
                  span.online-dot
                  span.online-count= user.onlineCount
                span= `/ ${user.devices.length}`
            .devices
              +deviceList(user.devices)

      //- Unassigned section
      if unassigned.devices.length > 0
        .section
          .section-header
            span.section-title= unassigned.name

          .group-section.dimmed
            .group-header
              .group-info
                span.group-name Зарегистрированы, но без владельца
              .group-stats
                if unassigned.onlineCount > 0
                  span.online-dot
                  span.online-count= unassigned.onlineCount
                span= `/ ${unassigned.devices.length}`
            .devices
              +deviceList(unassigned.devices)

      //- Unregistered section
      .section
        .section-header
          span.section-title= unregistered.name

        .group-section.dimmed
          .group-header
            .group-info
              span.group-name Обнаружены в сети
            .group-stats
              if unregistered.onlineCount > 0
                span.online-dot
                span.online-count= unregistered.onlineCount
              span= `/ ${unregistered.devices.length}`
          .devices
            +unregisteredDeviceList(unregistered.devices)

  //- Add user modal
  .modal(id="add-user")
    .modal-content
      .modal-title Добавить пользователя
      form(action="/users" method="POST")
        .form-group
          label.form-label Имя
          input.form-input(type="text" name="name" placeholder="Виталя" required)
        .form-group
          label.form-label Slug (латиницей)
          input.form-input(type="text" name="slug" placeholder="vitaliy" pattern="[a-z0-9-]+" required)
        .form-group
          label.form-checkbox
            input(type="checkbox" name="isAdmin")
            span Администратор
        .form-actions
          a.btn.btn-secondary(href="#") Отмена
          button.btn.btn-primary(type="submit") Создать

  //- Registration modals (outside dimmed section)
  each device in unregistered.devices
    .modal(id=`register-${device.mac.replace(/:/g, '')}`)
      .modal-content
        .modal-title Зарегистрировать устройство
        form(action="/devices/register" method="POST")
          input(type="hidden" name="mac" value=device.mac)
          .form-group
            label.form-label Название (из роутера)
            input.form-input(type="text" value=device.name disabled)
          .form-group
            label.form-label Свое название (опционально)
            input.form-input(type="text" name="customName" placeholder="Мой iPhone")
          .form-group
            label.form-label Владелец
            select.form-select(name="userId")
              option(value="") Без владельца
              each user in allUsers
                option(value=user.id)= user.name
          .form-group
            label.form-label Тип устройства
            select.form-select(name="deviceType")
              each type in deviceTypes
                option(value=type)= type
          .form-actions
            a.btn.btn-secondary(href="#") Отмена
            button.btn.btn-primary(type="submit") Добавить

  //- Edit device modals for user devices
  each user in users
    each device in user.devices
      +editDeviceModal(device)

  //- Edit device modals for unassigned devices
  each device in unassigned.devices
    +editDeviceModal(device)

  //- Edit user modals
  each user in users
    +editUserModal(user)

