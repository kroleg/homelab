extends layout
include partials/icons

block content
  style.
    .container {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1.5rem 1rem 2rem;
    }
    .two-columns {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
      width: 100%;
      max-width: 32rem;
    }
    @media (min-width: 64rem) {
      .two-columns {
        flex-direction: row;
        align-items: flex-start;
        max-width: 64rem;
      }
      .main-column {
        flex: 1;
        min-width: 0;
      }
      .side-column {
        width: 20rem;
        flex-shrink: 0;
      }
    }
    .sections {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
      width: 100%;
    }
    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.75rem;
      min-height: 1.625rem;
    }
    .section-title {
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--muted);
    }
    .add-btn {
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
      border: 1px solid #e4e4e7;
      border-radius: 0.375rem;
      background: white;
      color: var(--foreground);
      cursor: pointer;
      text-decoration: none;
    }
    .add-btn:hover { background: var(--secondary); }
    .group-section {
      background: var(--secondary);
      border-radius: 0.75rem;
      overflow: hidden;
      box-shadow: var(--card-shadow);
    }
    .group-section.dimmed { opacity: 0.7; }
    .user-section {
      margin-bottom: 1rem;
    }
    .user-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.5rem 0;
      gap: 0.5rem;
      text-decoration: none;
      color: inherit;
    }
    .user-header:hover .group-name {
      color: var(--primary);
    }
    .group-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem 1rem;
      background: #e4e4e7;
      gap: 0.5rem;
      text-decoration: none;
      color: inherit;
    }
    .clickable {
      cursor: pointer;
    }
    .clickable:hover {
      background: #d4d4d8;
    }
    .group-info {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex: 1;
      min-width: 0;
    }
    .group-name {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .admin-badge {
      font-size: 0.5rem;
      padding: 0.125rem 0.25rem;
      border-radius: 0.25rem;
      background: var(--primary);
      color: white;
      flex-shrink: 0;
    }
    .group-actions {
      display: flex;
      gap: 0.25rem;
    }
    .action-btn {
      font-size: 0.625rem;
      padding: 0.25rem 0.375rem;
      border: none;
      border-radius: 0.25rem;
      background: rgba(0,0,0,0.1);
      color: var(--foreground);
      cursor: pointer;
    }
    .action-btn:hover { background: rgba(0,0,0,0.2); }
    .action-btn.danger:hover { background: #fecaca; color: #dc2626; }
    .devices {
      display: flex;
      flex-direction: column;
    }
    .device-row {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.625rem 1rem;
      border-top: 1px solid #e4e4e7;
      text-decoration: none;
      color: inherit;
    }
    .device-row:first-child { border-top: none; }
    a.device-row:hover { background: #e4e4e7; }
    .status-dot {
      width: 0.5rem;
      height: 0.5rem;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .status-dot.online { background: var(--success); }
    .status-dot.offline { background: var(--muted); opacity: 0.4; }
    .device-icon {
      width: 1.125rem;
      height: 1.125rem;
      flex-shrink: 0;
    }
    .device-icon.online { color: var(--success); }
    .device-icon.offline { color: var(--muted); opacity: 0.4; }
    .device-info {
      flex: 1;
      min-width: 0;
    }
    .device-name {
      font-size: 1rem;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .device-details {
      font-size: 0.625rem;
      color: var(--muted);
      margin-top: 0.125rem;
    }
    .device-policy {
      font-size: 0.625rem;
      padding: 0.125rem 0.375rem;
      border-radius: 0.25rem;
      background: #dbeafe;
      color: #1e40af;
      flex-shrink: 0;
    }
    .device-actions {
      display: flex;
      gap: 0.25rem;
      flex-shrink: 0;
    }
    .empty-message {
      padding: 1rem;
      text-align: center;
      color: var(--muted);
      font-size: 0.875rem;
    }
    /* Forms */
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      align-items: center;
      justify-content: center;
      z-index: 100;
    }
    .modal:target { display: flex; }
    .modal-content {
      background: white;
      border-radius: 0.75rem;
      padding: 1.5rem;
      width: 90%;
      max-width: 24rem;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }
    .modal-title {
      font-size: 1.125rem;
      font-weight: 600;
      margin-bottom: 1rem;
    }
    .form-group {
      margin-bottom: 0.75rem;
    }
    .form-label {
      display: block;
      font-size: 0.75rem;
      font-weight: 500;
      margin-bottom: 0.25rem;
      color: var(--muted);
    }
    .form-input, .form-select {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid #a1a1aa;
      border-radius: 0.375rem;
      font-size: 0.875rem;
    }
    .form-input:disabled {
      border-color: #e4e4e7;
      background: #f4f4f5;
      color: var(--muted);
    }
    .form-input:focus, .form-select:focus {
      outline: none;
      border-color: var(--primary);
    }
    .form-checkbox {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .form-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
    }
    .btn {
      flex: 1;
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 0.375rem;
      font-size: 0.875rem;
      cursor: pointer;
      text-decoration: none;
      text-align: center;
      display: inline-block;
    }
    .btn-primary {
      background: var(--primary);
      color: white;
    }
    .btn-secondary {
      background: var(--secondary);
      color: var(--foreground);
    }
    .btn-danger {
      background: white;
      color: #dc2626;
      border: 1px solid #fecaca;
      width: 100%;
    }
    .btn-danger:hover {
      background: #fef2f2;
    }
    .delete-form {
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid #e4e4e7;
    }
    .inline-form {
      display: flex;
      gap: 0.25rem;
    }
    .inline-select {
      font-size: 0.625rem;
      padding: 0.125rem 0.25rem;
      border: 1px solid #e4e4e7;
      border-radius: 0.25rem;
      background: white;
    }

  mixin deviceList(devices)
    if devices.length === 0
      .empty-message Нет устройств
    else
      each device in devices
        - const dtype = device.deviceType || 'other'
        - const statusClass = device.online ? 'online' : 'offline'
        .device-row.clickable(data-device-id=device.id onclick="editDevice(this.dataset.deviceId)")
          if dtype === 'other'
            span.status-dot(class=statusClass)
          +deviceIcon(dtype, statusClass)
          .device-info
            .device-name= device.customName || device.keeneticName || device.name || device.mac
            .device-details
              span= device.mac
              if device.ip
                span= ` • ${device.ip}`
          if device.policy
            span.device-policy= device.policy

  mixin unregisteredDeviceList(devices)
    if devices.length === 0
      .empty-message Все устройства зарегистрированы
    else
      each device in devices
        - const statusClass = device.online ? 'online' : 'offline'
        a.device-row.clickable(href=`#register-${device.mac.replace(/:/g, '')}`)
          span.status-dot(class=statusClass)
          .device-info
            .device-name= device.name
            .device-details
              span= device.mac
              if device.ip
                span= ` • ${device.ip}`
          if device.policy
            span.device-policy= device.policy


  mixin editUserModal(user)
    .modal(id=`edit-user-${user.id}`)
      .modal-content
        .modal-title Редактировать пользователя
        form(action=`/users/${user.id}` method="POST")
          .form-group
            label.form-label Имя
            input.form-input(type="text" name="name" value=user.name required)
          .form-group
            label.form-label Slug (латиницей)
            input.form-input(type="text" name="slug" value=user.slug pattern="[a-z0-9-]+" required)
          .form-group
            label.form-checkbox
              input(type="checkbox" name="isAdmin" checked=user.isAdmin)
              span Администратор
          .form-actions
            a.btn.btn-secondary(href="#") Отмена
            button.btn.btn-primary(type="submit") Сохранить
        form.delete-form(action=`/users/${user.id}/delete` method="POST" onsubmit="return confirm('Удалить пользователя?')")
          button.btn.btn-danger(type="submit") Удалить пользователя

  .container
    .two-columns
      .main-column
        .sections
          //- Users section
          .section
            .section-header
              span
              a.add-btn(href="#add-user") + Добавить

            each user in users
              .user-section
                a.user-header(href=`#edit-user-${user.id}`)
                  .group-info
                    span.group-name= user.name
                    if user.isAdmin
                      span.admin-badge ADMIN
                .group-section
                  .devices
                    +deviceList(user.devices)

          //- Unassigned section
          if unassigned.devices.length > 0
            .section
              .section-header
                span.section-title= unassigned.name

              .group-section.dimmed
                .devices
                  +deviceList(unassigned.devices)

      //- Unregistered section (side column on wide screens)
      .side-column
        .sections
          .section
            .section-header
              span.section-title= unregistered.name

            .group-section.dimmed
              .devices
                +unregisteredDeviceList(unregistered.devices)

  //- Add user modal
  .modal(id="add-user")
    .modal-content
      .modal-title Добавить пользователя
      form(action="/users" method="POST")
        .form-group
          label.form-label Имя
          input.form-input(type="text" name="name" placeholder="Виталя" required)
        .form-group
          label.form-label Slug (латиницей)
          input.form-input(type="text" name="slug" placeholder="vitaliy" pattern="[a-z0-9-]+" required)
        .form-group
          label.form-checkbox
            input(type="checkbox" name="isAdmin")
            span Администратор
        .form-actions
          a.btn.btn-secondary(href="#") Отмена
          button.btn.btn-primary(type="submit") Создать

  //- Registration modals (outside dimmed section)
  each device in unregistered.devices
    .modal(id=`register-${device.mac.replace(/:/g, '')}`)
      .modal-content
        .modal-title Зарегистрировать устройство
        form(action="/devices/register" method="POST")
          input(type="hidden" name="mac" value=device.mac)
          .form-group
            label.form-label Название (из роутера)
            input.form-input(type="text" value=device.name disabled)
          .form-group
            label.form-label Свое название (опционально)
            input.form-input(type="text" name="customName" placeholder="Мой iPhone")
          .form-group
            label.form-label Владелец
            select.form-select(name="userId")
              option(value="") Без владельца
              each user in allUsers
                option(value=user.id)= user.name
          .form-group
            label.form-label Тип устройства
            select.form-select(name="deviceType")
              each type in deviceTypes
                option(value=type)= type
          .form-actions
            a.btn.btn-secondary(href="#") Отмена
            button.btn.btn-primary(type="submit") Добавить

  //- Single dynamic edit device modal
  #edit-device-modal.modal
    .modal-content
      .modal-title Редактировать устройство
      #edit-device-error.error(style="display:none")
      form#edit-device-form
        input#edit-device-id(type="hidden" name="id")
        .form-group
          label.form-label Название (из роутера)
          input#edit-device-keenetic-name.form-input(type="text" disabled)
        .form-group
          label.form-label Свое название
          input#edit-device-custom-name.form-input(type="text" name="customName" placeholder="Мой iPhone")
        .form-group
          label.form-label MAC
          input#edit-device-mac.form-input(type="text" disabled)
        .form-group
          label.form-label Владелец
          select#edit-device-user.form-select(name="userId")
        .form-group
          label.form-label Тип устройства
          select#edit-device-type.form-select(name="deviceType")
        .form-group
          label.form-label VPN
          select#edit-device-vpn.form-select(name="vpnPolicy")
        .form-actions
          button.btn.btn-secondary(type="button" onclick="closeModal()") Отмена
          button#edit-device-submit.btn.btn-primary(type="submit") Сохранить

  //- Edit user modals
  each user in users
    +editUserModal(user)

  script.
    const modal = document.getElementById('edit-device-modal');
    const form = document.getElementById('edit-device-form');
    const errorEl = document.getElementById('edit-device-error');

    function showModal() {
      modal.style.display = 'flex';
    }

    function closeModal() {
      modal.style.display = 'none';
      errorEl.style.display = 'none';
    }

    // Close modal on backdrop click
    modal.addEventListener('click', (e) => {
      if (e.target === modal) closeModal();
    });

    // Close modal on Escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeModal();
    });

    async function editDevice(id) {
      errorEl.style.display = 'none';
      document.getElementById('edit-device-submit').disabled = true;
      document.getElementById('edit-device-submit').textContent = 'Загрузка...';
      showModal();

      try {
        const res = await fetch(`/devices/${id}`);
        if (!res.ok) {
          const data = await res.json();
          throw new Error(data.error || 'Ошибка загрузки');
        }
        const { device, users, deviceTypes, vpnPolicies } = await res.json();

        // Populate form
        document.getElementById('edit-device-id').value = device.id;
        document.getElementById('edit-device-keenetic-name').value = device.keeneticName || '—';
        document.getElementById('edit-device-custom-name').value = device.customName || '';
        document.getElementById('edit-device-mac').value = device.mac;

        // Users dropdown
        const userSelect = document.getElementById('edit-device-user');
        userSelect.innerHTML = '<option value="">Без владельца</option>' +
          users.map(u => `<option value="${u.id}" ${device.userId === u.id ? 'selected' : ''}>${u.name}</option>`).join('');

        // Device types dropdown
        const typeSelect = document.getElementById('edit-device-type');
        typeSelect.innerHTML = deviceTypes.map(t =>
          `<option value="${t}" ${device.deviceType === t ? 'selected' : ''}>${t}</option>`
        ).join('');

        // VPN policies dropdown
        const vpnSelect = document.getElementById('edit-device-vpn');
        vpnSelect.innerHTML = '<option value="">Выкл</option>' +
          vpnPolicies.map(p => `<option value="${p.id}" ${device.policy === p.name ? 'selected' : ''}>${p.name}</option>`).join('');

        document.getElementById('edit-device-submit').disabled = false;
        document.getElementById('edit-device-submit').textContent = 'Сохранить';
      } catch (err) {
        errorEl.textContent = err.message;
        errorEl.style.display = 'block';
        document.getElementById('edit-device-submit').disabled = true;
        document.getElementById('edit-device-submit').textContent = 'Сохранить';
      }
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      errorEl.style.display = 'none';

      const id = document.getElementById('edit-device-id').value;
      const submitBtn = document.getElementById('edit-device-submit');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Сохранение...';

      try {
        const res = await fetch(`/devices/${id}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            customName: document.getElementById('edit-device-custom-name').value,
            userId: document.getElementById('edit-device-user').value,
            deviceType: document.getElementById('edit-device-type').value,
            vpnPolicy: document.getElementById('edit-device-vpn').value,
          }),
        });

        if (!res.ok) {
          const data = await res.json();
          throw new Error(data.error || 'Ошибка сохранения');
        }

        closeModal();
        location.reload();
      } catch (err) {
        errorEl.textContent = err.message;
        errorEl.style.display = 'block';
        submitBtn.disabled = false;
        submitBtn.textContent = 'Сохранить';
      }
    });
