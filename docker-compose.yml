services:
  traefik:
    container_name: traefik
    image: traefik:v3.0.0
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.file.filename=/etc/traefik/dynamic.yml"
      - "--providers.file.watch=true"
      - "--entrypoints.web.address=:80"
    ports:
      - "80:80"
      - "8080:8080"
    restart: unless-stopped
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik/dynamic.yml:/etc/traefik/dynamic.yml:ro
    networks:
      - default
      - shared

  glance:
    container_name: glance
    image: glanceapp/glance:v0.8.4
    restart: unless-stopped
    volumes:
      - ./glance/config:/app/config
      - ./glance/assets:/app/assets
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
    ports:
      - "8888:8080"
    networks:
      - shared
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.glance.rule=Host(`home.internal`)"
      - "traefik.http.routers.glance.entrypoints=web"
      - "traefik.http.services.glance.loadbalancer.server.port=8080"
      - "traefik.docker.network=shared"

  postgres-main:
    container_name: postgres-main
    image: postgres:16-alpine
    environment:
      - POSTGRES_DB=dns2vpn
      - POSTGRES_USER=dns2vpn
      - POSTGRES_PASSWORD=dns2vpn
    volumes:
      - postgres_main_data:/var/lib/postgresql/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U dns2vpn"]
      interval: 30s
      timeout: 5s
      retries: 3

  dns-to-vpn:
    container_name: dns-to-vpn
    depends_on:
      postgres-main:
        condition: service_healthy
      dns-proxy:
        condition: service_started
    build:
      context: ./main
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    volumes:
      - ./shared-logs:/logs
    environment:
      - WATCH_FILE=/logs/dns-proxy.log
      - POSTGRES_HOST=postgres-main
      - POSTGRES_PORT=5432
      - POSTGRES_DB=dns2vpn
      - POSTGRES_USER=dns2vpn
      - POSTGRES_PASSWORD=dns2vpn
      - KEENETIC_HOST=${KEENETIC_HOST}
      - KEENETIC_LOGIN=${KEENETIC_LOGIN}
      - KEENETIC_PASSWORD=${KEENETIC_PASSWORD}
      - DNS_API_URL=http://dns-proxy:3001
      - DEFAULT_VPN_INTERFACE=lithuania
    networks:
      - default
      - shared
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.admin.rule=Host(`admin.internal`)"
      - "traefik.http.routers.admin.entrypoints=web"
      - "traefik.http.services.admin.loadbalancer.server.port=3000"
      - "traefik.docker.network=shared"
    restart: unless-stopped

  # Static IP 192.168.80.53 - used by containers to bypass ISP DNS interception
  # See adr/001-dns-interception-bypass.md
  dns-proxy:
    container_name: dns-proxy
    build:
      context: ./dns-proxy
    environment:
      - LOG_RESOLVED_TO_FILE=/logs/dns-proxy.log
      - HOST_TO_IP_FILE=/config/host-to-ip.txt
      - BLOCKLIST_FILE=/config/blocklist.txt
      - ENABLE_API=true
      - API_PORT=3001
      # Upstream DNS servers: Use DNS over TLS for privacy
      # Format: protocol://host:port#servername
      # Examples:
      #   - dot://1.1.1.1:853#cloudflare-dns.com (Cloudflare DNS over TLS)
      #   - udp://192.168.1.1:53 (Plain DNS over UDP)
      # - UPSTREAM_DNS_SERVERS=dot://77.88.8.8:853#common.dot.dns.yandex.net
      - UPSTREAM_DNS_SERVERS=dot://1.1.1.1:853#cloudflare-dns.com
      # Alternate DNS for specific domains
      # those ips are routed through vpn to bypass dns geoblocking
      - ALT_DNS_UPSTREAM=udp://8.8.4.4:53
      - ALT_DNS_DOMAINS=themoviedb.org,tmdb.org,tmdb-image-prod.b-cdn.net
    ports:
      - "53:53/tcp"
      - "53:53/udp"
      - "3001:3001"
    volumes:
      - ./shared-logs:/logs
      - ./config:/config
    networks:
      default:
        ipv4_address: 192.168.80.53
    restart: unless-stopped

  vpn-toggle:
    container_name: vpn-toggle
    depends_on:
      - dns-to-vpn
      - keenetic-api
    build:
      context: ./vpn-toggle
      dockerfile: Dockerfile
    environment:
      - PORT=3002
      - MAIN_API_URL=http://dns-to-vpn:3000/api
      - KEENETIC_API_URL=http://keenetic-api:3005
      - ADMIN_ONLY_POLICIES=kz
    networks:
      - default
      - shared
    labels:
      - "traefik.enable=true"
      # Main router on vpn.internal
      - "traefik.http.routers.vpn.rule=Host(`vpn.internal`)"
      - "traefik.http.routers.vpn.entrypoints=web"
      - "traefik.http.services.vpn.loadbalancer.server.port=3002"
      # Redirect from old domain
      - "traefik.http.routers.vpn-redirect.rule=Host(`vpn-toggle.internal`)"
      - "traefik.http.routers.vpn-redirect.entrypoints=web"
      - "traefik.http.routers.vpn-redirect.middlewares=vpn-redirect"
      - "traefik.http.routers.vpn-redirect.service=vpn"
      - "traefik.http.middlewares.vpn-redirect.redirectregex.regex=^http://vpn-toggle\\.internal(.*)"
      - "traefik.http.middlewares.vpn-redirect.redirectregex.replacement=http://vpn.internal$${1}"
      - "traefik.http.middlewares.vpn-redirect.redirectregex.permanent=true"
      - "traefik.docker.network=shared"
    restart: unless-stopped

  family-dashboard:
    container_name: family-dashboard
    build:
      context: ./family-dashboard
      dockerfile: Dockerfile
    depends_on:
      - keenetic-api
    environment:
      - PORT=3006
      - KEENETIC_API_URL=http://keenetic-api:3005
    networks:
      - default
      - shared
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.family-dashboard.rule=Host(`dom.internal`)"
      - "traefik.http.routers.family-dashboard.entrypoints=web"
      - "traefik.http.services.family-dashboard.loadbalancer.server.port=3006"
      - "traefik.docker.network=shared"
    restart: unless-stopped

  keenetic-exporter:
    container_name: keenetic-exporter
    build:
      context: ./keenetic-exporter
    environment:
      - KEENETIC_HOST=${KEENETIC_HOST}
      - KEENETIC_LOGIN=${KEENETIC_LOGIN}
      - KEENETIC_PASSWORD=${KEENETIC_PASSWORD}
      - PORT=9101
      - MONITORED_INTERFACES=ISP,Wireguard0,Wireguard1,Wireguard2,Wireguard3
      - SCRAPE_INTERVAL_MS=60000
      - LOG_LEVEL=info
    restart: unless-stopped

  keenetic-api:
    container_name: keenetic-api
    build:
      context: ./keenetic-api
    environment:
      - KEENETIC_HOST=${KEENETIC_HOST}
      - KEENETIC_LOGIN=${KEENETIC_LOGIN}
      - KEENETIC_PASSWORD=${KEENETIC_PASSWORD}
      - PORT=3005
      - PROFILE_IDS=VITALIY,LEV,POLYA,MARINA
      - PROFILE_VITALIY_NAME=Виталя
      - PROFILE_VITALIY_ADMIN=true
      - PROFILE_LEV_NAME=Лев
      - PROFILE_POLYA_NAME=Поля
      - PROFILE_MARINA_NAME=Марина
    restart: unless-stopped

  calendar:
    container_name: calendar
    build:
      context: ./calendar
      dockerfile: Dockerfile
    env_file:
      - ./calendar/.env
    environment:
      - PORT=3003
      - CACHE_TTL_MINUTES=5
      - CALENDAR_IDS=FAMILY
      - CALENDAR_CONFIG_FAMILY_NAME=Семья
      - CALENDAR_CONFIG_FAMILY_COLOR=#FF383C
      - SUBCALENDAR_IDS=VASYA,LEV
      - SUBCALENDAR_VASYA_NAME=Вася
      - SUBCALENDAR_VASYA_COLOR=#FF69B4
      - SUBCALENDAR_LEV_NAME=Лев
      - SUBCALENDAR_LEV_COLOR=#B469FF
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3003/health"]
      interval: 30s
      timeout: 5s
      retries: 3
    networks:
      - default
      - shared
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.calendar.rule=Host(`calendar.internal`)"
      - "traefik.http.routers.calendar.entrypoints=web"
      - "traefik.http.services.calendar.loadbalancer.server.port=3003"
      - "traefik.docker.network=shared"
    restart: unless-stopped

  prometheus:
    container_name: prometheus
    image: prom/prometheus:v2.54.0
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=30d'
    restart: unless-stopped

  node-exporter:
    container_name: node-exporter
    image: prom/node-exporter:v1.8.2
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
    command:
      - '--path.procfs=/host/proc'
      - '--path.sysfs=/host/sys'
      - '--path.rootfs=/rootfs'
      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
      - '--collector.hwmon'
    restart: unless-stopped

  otel-collector:
    container_name: otel-collector
    image: otel/opentelemetry-collector-contrib:latest
    command: ["--config=/etc/otel-collector-config.yaml"]
    volumes:
      - ./otel/otel-collector-config.yaml:/etc/otel-collector-config.yaml:ro
    ports:
      - "4317:4317" # grpc
      - "4318:4318" # http
    restart: unless-stopped

  grafana:
    container_name: grafana
    image: grafana/grafana:11.3.0
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_USERS_ALLOW_SIGN_UP=false
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
      - ./grafana/dashboards:/var/lib/grafana/dashboards:ro
    depends_on:
      - prometheus
    networks:
      - default
      - shared
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.grafana.rule=Host(`grafana.internal`)"
      - "traefik.http.routers.grafana.entrypoints=web"
      - "traefik.http.services.grafana.loadbalancer.server.port=3000"
      - "traefik.docker.network=shared"
    restart: unless-stopped

  loki:
    container_name: loki
    image: grafana/loki:3.3.2
    command: -config.file=/etc/loki/local-config.yaml
    volumes:
      - loki_data:/loki
    restart: unless-stopped

  postgres-pagewatcher:
    container_name: postgres-pagewatcher
    image: postgres:16-alpine
    environment:
      - POSTGRES_DB=pagewatcher
      - POSTGRES_USER=pagewatcher
      - POSTGRES_PASSWORD=${PAGEWATCHER_DB_PASSWORD:-pagewatcher}
    volumes:
      - postgres_pagewatcher_data:/var/lib/postgresql/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U pagewatcher"]
      interval: 30s
      timeout: 5s
      retries: 3

  page-watcher:
    container_name: page-watcher
    depends_on:
      postgres-pagewatcher:
        condition: service_healthy
    build:
      context: ./page-watcher
      dockerfile: Dockerfile
    environment:
      - PORT=3004
      - POSTGRES_HOST=postgres-pagewatcher
      - POSTGRES_PORT=5432
      - POSTGRES_DB=pagewatcher
      - POSTGRES_USER=pagewatcher
      - POSTGRES_PASSWORD=${PAGEWATCHER_DB_PASSWORD:-pagewatcher}
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID}
    networks:
      - default
      - shared
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.page-watcher.rule=Host(`page-watcher.internal`)"
      - "traefik.http.routers.page-watcher.entrypoints=web"
      - "traefik.http.services.page-watcher.loadbalancer.server.port=3004"
      - "traefik.docker.network=shared"
    restart: unless-stopped

  promtail:
    container_name: promtail
    image: grafana/promtail:3.3.2
    volumes:
      - ./promtail/promtail.yaml:/etc/promtail/config.yml:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    depends_on:
      - loki
    restart: unless-stopped

  qbittorrent:
    container_name: qbittorrent
    image: linuxserver/qbittorrent:latest
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Moscow
      - WEBUI_PORT=8080
    volumes:
      - ./qbittorrent/config:/config
      - /mnt/data/media:/media
    ports:
      - "6881:6881"
      - "6881:6881/udp"
    networks:
      - default
      - shared
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.qbittorrent.rule=Host(`torrent.internal`)"
      - "traefik.http.routers.qbittorrent.entrypoints=web"
      - "traefik.http.services.qbittorrent.loadbalancer.server.port=8080"
      - "traefik.docker.network=shared"
    restart: unless-stopped

  jellyfin:
    container_name: jellyfin
    image: jellyfin/jellyfin:latest
    dns: [192.168.80.53]  # bypass ISP DNS interception, see adr/001-dns-interception-bypass.md
    sysctls:
      - net.ipv6.conf.all.disable_ipv6=1  # force IPv4, no IPv6 connectivity in this network
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Moscow
    volumes:
      - ./jellyfin/config:/config
      - ./jellyfin/cache:/cache
      - /mnt/data/media:/media:ro
    networks:
      - default
      - shared
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.jellyfin.rule=Host(`media.internal`)"
      - "traefik.http.routers.jellyfin.entrypoints=web"
      - "traefik.http.services.jellyfin.loadbalancer.server.port=8096"
      - "traefik.docker.network=shared"
    restart: unless-stopped

  torrent-ui:
    container_name: torrent-ui
    build:
      context: ./torrent-ui
    environment:
      - PORT=3007
      - QBITTORRENT_URL=http://qbittorrent:8080
      - KEENETIC_API_URL=http://keenetic-api:3005
      - RUTRACKER_COOKIE=${RUTRACKER_COOKIE}
      - USER_DOWNLOAD_LIMIT_GB=100
    dns: [192.168.80.53]
    depends_on:
      - qbittorrent
      - keenetic-api
    networks:
      - default
      - shared
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.torrent-ui.rule=Host(`dl.internal`)"
      - "traefik.http.routers.torrent-ui.entrypoints=web"
      - "traefik.http.services.torrent-ui.loadbalancer.server.port=3007"
      - "traefik.docker.network=shared"
    restart: unless-stopped

  devices:
    container_name: devices
    build:
      context: ./devices
      dockerfile: Dockerfile
    environment:
      - PORT=3009
      - LOG_LEVEL=info
      - KEENETIC_API_URL=http://keenetic-api:3005
    depends_on:
      - keenetic-api
    networks:
      - default
      - shared
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.devices.rule=Host(`devices.internal`)"
      - "traefik.http.routers.devices.entrypoints=web"
      - "traefik.http.services.devices.loadbalancer.server.port=3009"
      - "traefik.docker.network=shared"
    restart: unless-stopped

  telegram-bot:
    container_name: telegram-bot
    build: ./telegram-bot
    environment:
      - PORT=3008
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID}
      - LOG_LEVEL=info
      - SYS_PATH=/host/sys
      - PROC_PATH=/host/proc
      - ROOTFS_PATH=/rootfs
    volumes:
      - /sys:/host/sys:ro
      - /proc:/host/proc:ro
      - /:/rootfs:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    ports:
      - "3008:3008"
    networks:
      - default
      - shared
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.telegram-bot.rule=Host(`telegram-bot.internal`)"
      - "traefik.http.services.telegram-bot.loadbalancer.server.port=3008"
      - "traefik.docker.network=shared"
    restart: unless-stopped

  scrutiny:
    container_name: scrutiny
    image: ghcr.io/analogj/scrutiny:master-omnibus
    cap_add:
      - SYS_RAWIO
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Moscow
      - COLLECTOR_CRON_SCHEDULE=0 * * * *
    volumes:
      - ./scrutiny/config:/opt/scrutiny/config
      - ./scrutiny/influxdb:/opt/scrutiny/influxdb
      - /run/udev:/run/udev:ro
    devices:
      - /dev/sda:/dev/sda
      - /dev/sdb:/dev/sdb
    networks:
      - default
      - shared
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.scrutiny.rule=Host(`disk-monitor.internal`)"
      - "traefik.http.routers.scrutiny.entrypoints=web"
      - "traefik.http.services.scrutiny.loadbalancer.server.port=8080"
      - "traefik.docker.network=shared"
    restart: unless-stopped

networks:
  default:
    ipam:
      config:
        - subnet: 192.168.80.0/20
  shared:
    name: shared

volumes:
  postgres_main_data:
  postgres_pagewatcher_data:
  prometheus_data:
  grafana_data:
  loki_data:
