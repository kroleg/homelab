doctype html
html(lang="ru")
  head
    meta(charset="UTF-8")
    meta(name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no")
    meta(name="apple-mobile-web-app-capable" content="yes")
    meta(name="apple-mobile-web-app-status-bar-style" content="black-translucent")
    meta(http-equiv="refresh" content=`${refreshInterval}`)
    title= title
    style.
      * {
        box-sizing: border-box;
      }
      html, body {
        margin: 0;
        padding: 0;
        height: 100%;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: #f5f5f5;
      }
      .container {
        height: 100%;
        padding: 10px;
        display: flex;
        flex-direction: column;
      }
      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        flex-shrink: 0;
        flex-wrap: wrap;
        gap: 8px;
      }
      header h1 {
        margin: 0;
        font-size: 1.5rem;
        font-weight: 600;
      }
      .header-right {
        display: flex;
        align-items: center;
        gap: 16px;
      }
      .calendar-legend {
        display: flex;
        gap: 12px;
        font-size: 0.85rem;
      }
      .legend-item {
        display: flex;
        align-items: center;
        gap: 4px;
      }
      .legend-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
      }
      .nav-controls {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .nav-btn {
        padding: 8px 16px;
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 4px;
        text-decoration: none;
        color: #333;
        font-size: 0.9rem;
        cursor: pointer;
      }
      .nav-btn:hover {
        background: #f0f0f0;
      }
      .week-title {
        font-size: 1rem;
        font-weight: 500;
        min-width: 200px;
        text-align: center;
      }
      .calendar-wrapper {
        flex: 1;
        background: white;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        overflow: auto;
        display: flex;
        flex-direction: column;
      }
      .day-headers {
        display: grid;
        grid-template-columns: 60px repeat(7, 1fr);
        border-bottom: 1px solid #e0e0e0;
        position: sticky;
        top: 0;
        background: white;
        z-index: 10;
      }
      .time-header {
        padding: 8px;
        border-right: 1px solid #e0e0e0;
      }
      .day-header {
        padding: 8px;
        text-align: center;
        border-right: 1px solid #e0e0e0;
        font-weight: 500;
      }
      .day-header:last-child {
        border-right: none;
      }
      .day-header.today {
        background: #e3f2fd;
      }
      .day-header .day-name {
        font-size: 0.85rem;
        color: #666;
      }
      .day-header .day-num {
        font-size: 1.2rem;
        font-weight: 600;
      }
      .day-header.today .day-num {
        background: #1976d2;
        color: white;
        border-radius: 50%;
        width: 32px;
        height: 32px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }
      .all-day-section {
        border-bottom: 2px solid #e0e0e0;
        min-height: 30px;
        display: grid;
        grid-template-columns: 60px repeat(7, 1fr);
      }
      .all-day-label {
        padding: 4px 8px;
        font-size: 0.75rem;
        color: #666;
        border-right: 1px solid #e0e0e0;
        display: flex;
        align-items: center;
      }
      .all-day-cell {
        border-right: 1px solid #e0e0e0;
        padding: 2px;
        display: flex;
        flex-direction: column;
        gap: 2px;
      }
      .all-day-cell:last-child {
        border-right: none;
      }
      .all-day-event {
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 0.75rem;
        color: white;
        text-shadow: 0 1px 1px rgba(0,0,0,0.2);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        cursor: pointer;
      }
      .time-grid-wrapper {
        flex: 1;
        display: grid;
        grid-template-columns: 60px repeat(7, 1fr);
        min-height: 680px;
      }
      .time-labels {
        display: flex;
        flex-direction: column;
        border-right: 1px solid #e0e0e0;
      }
      .time-label {
        height: 40px;
        padding: 0 8px;
        font-size: 0.75rem;
        color: #666;
        text-align: right;
        border-bottom: 1px solid #f0f0f0;
        display: flex;
        align-items: flex-start;
        justify-content: flex-end;
      }
      .day-column {
        position: relative;
        border-right: 1px solid #e0e0e0;
      }
      .day-column:last-child {
        border-right: none;
      }
      .hour-line {
        position: absolute;
        left: 0;
        right: 0;
        height: 40px;
        border-bottom: 1px solid #f0f0f0;
      }
      .event {
        position: absolute;
        left: 2px;
        right: 2px;
        padding: 2px 4px;
        border-radius: 4px;
        font-size: 0.75rem;
        overflow: hidden;
        cursor: pointer;
        color: white;
        text-shadow: 0 1px 1px rgba(0,0,0,0.2);
        z-index: 1;
      }
      .event:hover {
        z-index: 2;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      }
      .event-title {
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .event-time {
        font-size: 0.7rem;
        opacity: 0.9;
      }
      /* Modal styles */
      .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
        justify-content: center;
        align-items: center;
      }
      .modal-overlay.show {
        display: flex;
      }
      .modal-content {
        background: white;
        border-radius: 12px;
        padding: 20px;
        max-width: 400px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
      }
      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 16px;
      }
      .modal-title {
        font-size: 1.25rem;
        font-weight: 600;
        margin: 0;
        padding-right: 16px;
      }
      .modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #666;
        padding: 0;
        line-height: 1;
      }
      .modal-body p {
        margin: 8px 0;
        color: #333;
      }
      .modal-body .label {
        font-weight: 500;
        color: #666;
      }
  body
    .container
      header
        h1= title
        .header-right
          .calendar-legend
            each cal in calendars
              .legend-item
                .legend-dot(style=`background-color: ${cal.color}`)
                span= cal.name
          .nav-controls
            a.nav-btn(href=`/?week=${prevWeek}`) &larr;
            span.week-title= weekTitle
            a.nav-btn(href=`/?week=${nextWeek}`) &rarr;
            a.nav-btn(href="/") Сегодня

      .calendar-wrapper
        .day-headers
          .time-header
          each day in days
            .day-header(class=day.isToday ? 'today' : '')
              .day-name= day.dayName
              .day-num= day.dayNum

        .all-day-section
          .all-day-label Весь день
          each day in days
            .all-day-cell
              each event in day.allDayEvents
                .all-day-event(
                  style=`background-color: ${event.color}`
                  data-event-id=event.id
                  onclick=`showModal('${event.id}')`
                )= event.title

        .time-grid-wrapper
          .time-labels
            - const hours = [6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22]
            each hour in hours
              .time-label= hour.toString().padStart(2, '0') + ':00'

          each day in days
            .day-column
              //- Hour lines for visual grid
              each hour in hours
                .hour-line(style=`top: ${(hour - 6) * 40}px`)
              //- Events
              each event in day.timedEvents
                .event(
                  style=`background-color: ${event.color}; top: ${event.topPx}px; height: ${event.heightPx}px`
                  data-event-id=event.id
                  onclick=`showModal('${event.id}')`
                )
                  .event-title= event.title
                  .event-time= event.timeStr

    //- Event detail modal
    .modal-overlay#eventModal
      .modal-content
        .modal-header
          h2.modal-title#modalTitle
          button.modal-close(type="button" onclick="closeModal()") &times;
        .modal-body
          p
            span.label Время:
            |
            span#modalTime
          p#modalLocationRow(style="display: none")
            span.label Место:
            |
            span#modalLocation
          p#modalDescRow(style="display: none")
            span.label Описание:
            |
            span#modalDescription
          p
            span.label Календарь:
            |
            span#modalCalendar

    //- Event data for modal
    script.
      var eventsData = !{JSON.stringify(eventsData)};
      var calendars = !{JSON.stringify(calendars)};

      function showModal(eventId) {
        var event = eventsData[eventId];
        if (!event) return;

        document.getElementById('modalTitle').textContent = event.title;
        document.getElementById('modalTime').textContent = event.timeDisplay;

        var locationRow = document.getElementById('modalLocationRow');
        if (event.location) {
          document.getElementById('modalLocation').textContent = event.location;
          locationRow.style.display = 'block';
        } else {
          locationRow.style.display = 'none';
        }

        var descRow = document.getElementById('modalDescRow');
        if (event.description) {
          document.getElementById('modalDescription').textContent = event.description;
          descRow.style.display = 'block';
        } else {
          descRow.style.display = 'none';
        }

        var cal = null;
        for (var i = 0; i < calendars.length; i++) {
          if (calendars[i].id === event.calendarId) {
            cal = calendars[i];
            break;
          }
        }
        document.getElementById('modalCalendar').textContent = cal ? cal.name : event.calendarId;

        document.getElementById('eventModal').className = 'modal-overlay show';
      }

      function closeModal() {
        document.getElementById('eventModal').className = 'modal-overlay';
      }

      document.getElementById('eventModal').onclick = function(e) {
        if (e.target === this) closeModal();
      };
